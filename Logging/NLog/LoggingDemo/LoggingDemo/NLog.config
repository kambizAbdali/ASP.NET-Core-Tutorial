<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      internalLogLevel="Info"
      internalLogFile="internal-nlog.txt">

	<!-- Global Variables -->
	<variable name="appName" value="LoggingDemo" />
	<variable name="logDirectory" value="logs" />

	<!-- Targets -->
	<targets async="true">

		<!-- 1. Colored Console Target -->
		<target name="coloredConsole"
				xsi:type="ColoredConsole"
				layout="${longdate} | ${level:uppercase=true:padding=5} | ${logger:shortName=true} | ${message} ${exception:format=tostring}"
				useDefaultRowHighlightingRules="false">
			<highlight-row condition="level == LogLevel.Fatal" foregroundColor="Red" backgroundColor="White" />
			<highlight-row condition="level == LogLevel.Error" foregroundColor="Red" />
			<highlight-row condition="level == LogLevel.Warn" foregroundColor="Yellow" />
			<highlight-row condition="level == LogLevel.Info" foregroundColor="White" />
			<highlight-row condition="level == LogLevel.Debug" foregroundColor="Gray" />
			<highlight-row condition="level == LogLevel.Trace" foregroundColor="DarkGray" />
		</target>

		<!-- 2. All Logs File -->
		<target name="allFile"
				xsi:type="File"
				fileName="${logDirectory}/all-${shortdate}.log"
				layout="${longdate} | ${level:uppercase=true:padding=5} | ${logger} | ${message} ${exception:format=tostring}"
				archiveFileName="${logDirectory}/archive/all-{#####}.log"
				archiveAboveSize="10485760"
		archiveNumbering="Sequence"
		maxArchiveFiles="10"
		concurrentWrites="true"
		keepFileOpen="true" />

		<!-- 3. Error Logs File -->
		<target name="errorFile"
				xsi:type="File"
				fileName="${logDirectory}/error-${shortdate}.log"
				layout="${longdate} | ${level:uppercase=true} | ${logger} | ${message} ${exception:format=tostring}"
				archiveFileName="${logDirectory}/archive/error-{#####}.log"
				archiveAboveSize="5242880"
		archiveNumbering="Sequence"
		maxArchiveFiles="20" />

		<!-- 4. JSON Format Logs -->
		<target name="jsonFile"
				xsi:type="File"
				fileName="${logDirectory}/json-${shortdate}.json"
				archiveFileName="${logDirectory}/archive/json-{#####}.json"
				archiveAboveSize="10485760"
				maxArchiveFiles="5">

			<layout xsi:type="JsonLayout" includeAllProperties="true">
				<attribute name="timestamp" layout="${date:format=yyyy-MM-dd HH\:mm\:ss}" />
				<attribute name="level" layout="${level:uppercase=true}" />
				<attribute name="logger" layout="${logger}" />
				<attribute name="message" layout="${message}" />
				<attribute name="machineName" layout="${machinename}" />
				<attribute name="processId" layout="${processid}" />
				<attribute name="threadId" layout="${threadid}" />
				<attribute name="application" layout="${appName}" />
				<attribute name="environment" layout="${environment:variable=ASPNETCORE_ENVIRONMENT}" />

				<!-- Include all event properties -->
				<attribute name="eventProperties">
					<layout xsi:type="JsonLayout" includeAllProperties="true" />
				</attribute>

				<!-- Exception details -->
				<attribute name="exception" layout="${exception:format=tostring}" />
			</layout>
		</target>

		<!-- 5. Database Target - FIXED: Removed extra > character -->
		<target name="database"
				xsi:type="Database"
				dbProvider="Microsoft.Data.SqlClient.SqlConnection, Microsoft.Data.SqlClient"
				connectionString="Server=.;Database=LoggingDb;Integrated Security=true;TrustServerCertificate=true"
				commandText="INSERT INTO ApplicationLogs (TimeStamp, Level, Logger, Message, Exception, MachineName, UserName, ApplicationName) VALUES (@TimeStamp, @Level, @Logger, @Message, @Exception, @MachineName, @UserName, @ApplicationName)">

			<parameter name="@TimeStamp" layout="${date:format=yyyy-MM-dd HH\:mm\:ss}" />
			<parameter name="@Level" layout="${level}" />
			<parameter name="@Logger" layout="${logger}" />
			<parameter name="@Message" layout="${message}" />
			<parameter name="@Exception" layout="${exception:format=tostring}" />
			<parameter name="@MachineName" layout="${machinename}" />
			<parameter name="@UserName" layout="${environment-user:userName=true:domain=true}" />
			<parameter name="@ApplicationName" layout="${appName}" />
		</target>

		<!-- 6. Custom Layout File -->
		<target name="customFile"
				xsi:type="File"
				fileName="${logDirectory}/custom-${shortdate}.log"
				layout="${longdate} | ${level:uppercase=true} | ${logger:shortName=true} | User: ${environment-user} | Machine: ${machinename} | ${message} ${exception:format=tostring}" />

	</targets>

	<!-- Rules -->
	<rules>
		<!-- All logs to console (development only) -->
		<logger name="*" minlevel="Trace" writeTo="coloredConsole" />

		<!-- All logs to main file -->
		<logger name="*" minlevel="Debug" writeTo="allFile" />

		<!-- Errors and above to error file -->
		<logger name="*" minlevel="Warn" writeTo="errorFile" />

		<!-- Information and above to JSON file -->
		<logger name="*" minlevel="Info" writeTo="jsonFile" />

		<!-- Critical errors to database -->
		<logger name="*" minlevel="Error" writeTo="database" />

		<!-- Custom logging for specific namespaces -->
		<logger name="LoggingDemo.Services.*" minlevel="Debug" writeTo="customFile" />
		<logger name="LoggingDemo.Controllers.*" minlevel="Info" writeTo="customFile" />

		<!-- Blackhole for Microsoft logs to reduce noise -->
		<logger name="Microsoft.*" maxlevel="Info" final="true" />
		<logger name="System.*" maxlevel="Info" final="true" />
	</rules>
</nlog>